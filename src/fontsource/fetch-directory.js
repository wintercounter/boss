/* eslint-disable no-console */
const fs = require('node:fs/promises')
const path = require('node:path')

const API_BASE = 'https://api.fontsource.org'

const fetchJson = async url => {
    const res = await fetch(url)
    if (!res.ok) {
        throw new Error(`Fontsource sync failed: ${res.status} ${res.statusText} for ${url}`)
    }
    return res.json()
}

const toSortedArray = (set, compare) => Array.from(set).sort(compare)

const main = async () => {
    const fonts = await fetchJson(`${API_BASE}/v1/fonts`)
    const versionMap = await fetchJson(`${API_BASE}/fontlist?version`)

    const subsets = new Set()
    const weights = new Set()
    const styles = new Set()
    const categories = new Set()
    const types = new Set()
    const families = new Set()
    const ids = new Set()
    const versions = new Set()

    const enrichedFonts = fonts.map(entry => {
        const version = versionMap?.[entry.id]
        if (version) {
            versions.add(version)
        }
        entry.subsets?.forEach(value => subsets.add(value))
        entry.weights?.forEach(value => weights.add(Number(value)))
        entry.styles?.forEach(value => styles.add(value))
        if (entry.category) categories.add(entry.category)
        if (entry.type) types.add(entry.type)
        if (entry.family) families.add(entry.family)
        if (entry.id) ids.add(entry.id)
        return { ...entry, version: version ?? null }
    })

    const header = `/* eslint-disable */\n// Generated by src/fontsource/fetch-directory.js at ${new Date().toISOString()}\n\n`

    const output =
        header +
        `export const fontDirectory = ${JSON.stringify(enrichedFonts, null, 4)} as const\n\n` +
        `export const fontFamilies = ${JSON.stringify(toSortedArray(families))} as const\n` +
        `export const fontIds = ${JSON.stringify(toSortedArray(ids))} as const\n` +
        `export const fontSubsets = ${JSON.stringify(toSortedArray(subsets))} as const\n` +
        `export const fontWeights = ${JSON.stringify(toSortedArray(weights, (a, b) => a - b))} as const\n` +
        `export const fontStyles = ${JSON.stringify(toSortedArray(styles))} as const\n` +
        `export const fontCategories = ${JSON.stringify(toSortedArray(categories))} as const\n` +
        `export const fontTypes = ${JSON.stringify(toSortedArray(types))} as const\n` +
        `export const fontVersions = ${JSON.stringify(toSortedArray(versions))} as const\n\n` +
        `export type FontDirectoryEntry = typeof fontDirectory[number]\n` +
        `export type FontFamily = typeof fontFamilies[number]\n` +
        `export type FontId = typeof fontIds[number]\n` +
        `export type FontSubset = typeof fontSubsets[number]\n` +
        `export type FontWeight = typeof fontWeights[number]\n` +
        `export type FontStyle = typeof fontStyles[number]\n` +
        `export type FontCategory = typeof fontCategories[number]\n` +
        `export type FontType = typeof fontTypes[number]\n` +
        `export type FontVersion = typeof fontVersions[number]\n`

    const outputPath = path.join(process.cwd(), 'src/fontsource/directory.ts')
    await fs.writeFile(outputPath, output)

    console.log(`Wrote ${outputPath}`)
}

main().catch(err => {
    console.error(err)
    process.exit(1)
})
